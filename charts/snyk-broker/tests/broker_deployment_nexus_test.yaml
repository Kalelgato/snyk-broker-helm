# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: broker deployment (nexus)
chart:
  version: 0.0.0
values:
  - ./fixtures/default_values.yaml
templates:
  - secrets.yaml
  - broker_deployment.yaml
set:
  scmType: nexus

tests:
  - it: should create secrets if brokerClientValidationUrl, baseNexusUrl and nexusUrl are defined
    template: secrets.yaml
    set:
      baseNexusUrl: https://username:password@your-domain.com
      nexusUrl: https://username:password@your-domain.com/repository
      brokerClientValidationUrl: https://username:password@your-domain.com/service/rest/v1/status/check
      disableSuffixes: true

    asserts:

      - isKind:
          of: Secret
        documentSelector:
          path: metadata.name
          value: &nexusBrokerClientValidationUrl nexus-broker-validation-url-snyk-broker
      - equal:
          path: stringData.nexus-broker-client-validation-url
          value: https://username:password@your-domain.com/service/rest/v1/status/check
        documentSelector:
          path: metadata.name
          value: *nexusBrokerClientValidationUrl

      - isKind:
          of: Secret
        documentSelector:
          path: metadata.name
          value: &nexusUrl nexus-url-snyk-broker
      - equal:
          path: data.nexus-nexus-url
          value: aHR0cHM6Ly91c2VybmFtZTpwYXNzd29yZEB5b3VyLWRvbWFpbi5jb20vcmVwb3NpdG9yeQ==
        documentSelector:
          path: metadata.name
          value: *nexusUrl

      - isKind:
          of: Secret
        documentSelector:
          path: metadata.name
          value: &nexusBaseUrl nexus-base-url-snyk-broker
      - equal:
          path: data.nexus-base-nexus-url
          value: aHR0cHM6Ly91c2VybmFtZTpwYXNzd29yZEB5b3VyLWRvbWFpbi5jb20=
        documentSelector:
          path: metadata.name
          value: *nexusBaseUrl


  - it: should create secrets if brokerClientValidationUrl and nexusUrl are defined
    template: secrets.yaml

    set:
      nexusUrl: https://username:password@your-domain.com/repository
      brokerClientValidationUrl: https://username:password@your-domain.com/service/rest/v1/status/check
      disableSuffixes: true

    asserts:

      - isKind:
          of: Secret
        documentSelector:
          path: metadata.name
          value: *nexusBrokerClientValidationUrl
      - equal:
          path: stringData.nexus-broker-client-validation-url
          value: https://username:password@your-domain.com/service/rest/v1/status/check
        documentSelector:
          path: metadata.name
          value: *nexusBrokerClientValidationUrl

      - isKind:
          of: Secret
        documentSelector:
          path: metadata.name
          value: *nexusUrl
      - equal:
          path: data.nexus-nexus-url
          value: aHR0cHM6Ly91c2VybmFtZTpwYXNzd29yZEB5b3VyLWRvbWFpbi5jb20vcmVwb3NpdG9yeQ==
        documentSelector:
          path: metadata.name
          value: *nexusUrl

      - containsDocument:
          kind: Secret
          apiVersion: v1
          name: *nexusBaseUrl
        not: true

  - it: should create secrets if brokerClientValidationUrl and baseNexusUrl are defined
    template: secrets.yaml

    set:
      baseNexusUrl: https://username:password@your-domain.com
      brokerClientValidationUrl: https://username:password@your-domain.com/service/rest/v1/status/check
      disableSuffixes: true

    asserts:

      - isKind:
          of: Secret
        documentSelector:
          path: metadata.name
          value: *nexusBrokerClientValidationUrl
      - equal:
          path: stringData.nexus-broker-client-validation-url
          value: https://username:password@your-domain.com/service/rest/v1/status/check
        documentSelector:
          path: metadata.name
          value: *nexusBrokerClientValidationUrl

      - isKind:
          of: Secret
        documentSelector:
          path: metadata.name
          value: *nexusBaseUrl
      - equal:
          path: data.nexus-base-nexus-url
          value: aHR0cHM6Ly91c2VybmFtZTpwYXNzd29yZEB5b3VyLWRvbWFpbi5jb20=
        documentSelector:
          path: metadata.name
          value: *nexusBaseUrl

      - containsDocument:
          kind: Secret
          apiVersion: v1
          name: *nexusUrl
        not: true

  - it: should not create secret for brokerClientValidationUrl if value is empty
    template: secrets.yaml

    set:
      nexusUrl: https://username:password@your-domain.com/repository
      baseNexusUrl: https://username:password@your-domain.com
      disableSuffixes: true

    asserts:
      - containsDocument:
          kind: Secret
          apiVersion: v1
          name: *nexusBrokerClientValidationUrl
        not: true

  - it: references secrets in deployment
    release:
      name: unittest
    template: broker_deployment.yaml
    set:
      baseNexusUrl: https://username:password@your-domain.com
      nexusUrl: https://username:password@your-domain.com/repository
      brokerClientValidationUrl: https://username:password@your-domain.com/service/rest/v1/status/check

    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: BASE_NEXUS_URL
            valueFrom:
              secretKeyRef:
                name: nexus-base-url-unittest-snyk-broker
                key: "nexus-base-nexus-url"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NEXUS_URL
            valueFrom:
              secretKeyRef:
                name: nexus-url-unittest-snyk-broker
                key: "nexus-nexus-url"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: BROKER_CLIENT_VALIDATION_URL
            valueFrom:
              secretKeyRef:
                name: nexus-broker-validation-url-unittest-snyk-broker
                key: "nexus-broker-client-validation-url"
