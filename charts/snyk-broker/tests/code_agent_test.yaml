# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: code agent
values:
  - ./fixtures/default_values.yaml
set:
  enableCodeAgent: true
templates:
  - code_agent_deployment.yaml
  - broker_deployment.yaml
tests:
  - it: Renders with default values
    asserts:
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: GIT_CLIENT_URL
          value: "http://RELEASE-NAME-code-agent:3000"
      template: broker_deployment.yaml
    - equal:
        path: metadata.name
        value: RELEASE-NAME-code-agent
      template: code_agent_deployment.yaml
      documentSelector:
        path: kind
        value: Service
    - contains:
        path: spec.template.spec.containers[0].ports
        content:
          name: http
          containerPort: 3000
      template: code_agent_deployment.yaml
      documentSelector:
        path: kind
        value: Deployment
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: PORT
          value: "3000"
      template: code_agent_deployment.yaml
      documentSelector:
        path: kind
        value: Deployment
  - it: Renders with suffixes disabled
    set:
      disableSuffixes: true
    asserts:
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: GIT_CLIENT_URL
          value: "http://code-agent:3000"
      template: broker_deployment.yaml
    - equal:
        path: metadata.name
        value: code-agent
      template: code_agent_deployment.yaml
      documentSelector:
        path: kind
        value: Service
