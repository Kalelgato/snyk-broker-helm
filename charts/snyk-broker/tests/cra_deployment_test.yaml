suite: test container registry & broker deployment
chart:
  version: 0.0.0
templates:
  - cra_deployment.yaml
  - broker_deployment.yaml
values:
  - ./fixtures/default_values.yaml

tests:
  - it: default values
    set:
      crType: nexus-cr
    values:
      - ./fixtures/default_values_cra.yaml
    asserts:
      - matchSnapshot: {}
      - equal:
          path: metadata.name
          value: &serviceName RELEASE-NAME-container-registry-agent
        template:
          cra_deployment.yaml
        documentSelector:
          path: kind
          value: Service
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CR_AGENT_URL
            value: "http://RELEASE-NAME-container-registry-agent:8081"
        template:
          broker_deployment.yaml
      - equal:
          path: spec.selector["app.kubernetes.io/name"]
          value: RELEASE-NAME-container-registry-agent
        template: cra_deployment.yaml
        documentSelector:
          path: kind
          value: Service
      - contains:
          path: spec.ports
          content:
            port: 8081
            targetPort: 8081
        template: cra_deployment.yaml
        documentSelector:
          path: kind
          value: Service
      - equal:
          path: metadata.name
          value: container-registry-agent-RELEASE-NAME-snyk-broker
        template: broker_deployment.yaml
  - it: with suffixes disabled
    set:
      crType: nexus-cr
      disableSuffixes: true
    values:
      - ./fixtures/default_values_cra.yaml
    asserts:
      - matchSnapshot: {}
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CR_AGENT_URL
            value: "http://container-registry-agent:8081"
        template:
          broker_deployment.yaml
      - equal:
          path: metadata.name
          value: container-registry-agent
        template:
          cra_deployment.yaml
        documentSelector:
          path: kind
          value: Service
      - equal:
          path: spec.selector["app.kubernetes.io/name"]
          value: container-registry-agent
        template: cra_deployment.yaml
        documentSelector:
          path: kind
          value: Service
      - equal:
          path: metadata.name
          value: container-registry-agent-snyk-broker
        template: broker_deployment.yaml
