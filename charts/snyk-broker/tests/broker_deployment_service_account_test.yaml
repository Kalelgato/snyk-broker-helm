# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test broker service account
chart:
  version: 0.0.0
templates:
  - &brokerDep broker_deployment.yaml
  - &craDep cra_deployment.yaml
  - &caDep code_agent_deployment.yaml
  - &sa serviceaccount.yaml
values:
  - ../values.yaml
  - ./fixtures/default_values.yaml
set:
  enableCodeAgent: true
  scmType: container-registry-agent

tests:
  - it: uses the generated service account
    asserts:
    - equal:
        path: &serviceAccountNamePath spec.template.spec.serviceAccountName
        value: &defaultServiceAccountName snyk-broker-RELEASE-NAME
      template: *brokerDep
    - equal:
        path: *serviceAccountNamePath
        value: *defaultServiceAccountName
      template: *craDep
      documentIndex: 0
    - equal:
        path: *serviceAccountNamePath
        value: *defaultServiceAccountName
      template: *caDep
      documentIndex: 0
    - equal:
        path: metadata.name
        value: *defaultServiceAccountName
      template: *sa
  - it: creates a serviceaccount with specified name
    set:
      serviceAccount.name: "my-custom-service-account-name"
    asserts:
    - equal:
        path: *serviceAccountNamePath
        value: &myCustomServiceAccountName my-custom-service-account-name-RELEASE-NAME
      template: *brokerDep
    - equal:
        path: *serviceAccountNamePath
        value: *myCustomServiceAccountName
      template: *craDep
      documentIndex: 0
    - equal:
        path: *serviceAccountNamePath
        value: *myCustomServiceAccountName
      template: *caDep
      documentIndex: 0
    - equal:
        path: metadata.name
        value: *myCustomServiceAccountName
      template: *sa
  - it: falls back to the `default` service account if name is empty
    set:
      serviceAccount.create: false
      serviceAccount.name: ""
    asserts:
    - hasDocuments:
        count: 0
      template: *sa
    - equal:
        path: *serviceAccountNamePath
        value: &defaultServiceAccount default
      template: *brokerDep
    - equal:
        path: *serviceAccountNamePath
        value: *defaultServiceAccount
      template: *craDep
      documentIndex: 0
    - equal:
        path: *serviceAccountNamePath
        value: *defaultServiceAccount
      template: *caDep
      documentIndex: 0
  - it: uses an external service account
    set:
      serviceAccount.create: false
      serviceAccount.name: "my-external-service-account"
    asserts:
    - hasDocuments:
        count: 0
      template: *sa
    - equal:
        path: *serviceAccountNamePath
        value: &myExternalServiceAccount my-external-service-account
      template: *brokerDep
    - equal:
        path: *serviceAccountNamePath
        value: *myExternalServiceAccount
      template: *craDep
      documentIndex: 0
    - equal:
        path: *serviceAccountNamePath
        value: *myExternalServiceAccount
      template: *caDep
      documentIndex: 0
  - it: does not use or generate a service account
    set:
      serviceAccount.enabled: false
    asserts:
    - hasDocuments:
        count: 0
      template: *sa
    - notExists:
        path: *serviceAccountNamePath
      template: *brokerDep
    - notExists:
        path: *serviceAccountNamePath
      template: *craDep
      documentIndex: 0
    - notExists:
        path: *serviceAccountNamePath
      template: *caDep
      documentIndex: 0
